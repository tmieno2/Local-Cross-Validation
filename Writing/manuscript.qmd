---
title: "A new model selection approach based on local economically optimal input rate"
author:
  - name: Mona Mousavi
    orcid: 
    email: mmousavi2@huskers.unl.edu
    affiliations:
      - name: University of Nebraska Lincoln
  - name: Taro Mieno
    orcid: 
    email: tmieno2@unl.edu
    affiliations:
      - name: University of Nebraska Lincoln
  - name: Xiaofei Li
    orcid: 
    email: xiaofei.li@msstate.edu
    affiliations:
      - name: Mississippi State University
  - name: David S. Bullock
    orcid: 
    email: dsbulloc@illinois.edu
    affiliations:
      - name: University of Illinois
format: 
  html: 
    number-sections: true
    number-depth: 3
  docx: 
    number-sections: true
    number-depth: 3
bibliography: PA.bib
csl: american-journal-of-agricultural-economics.csl
abstract: ""
---


```{r echo = F, cache = F, include = F}
library(knitr)

opts_chunk$set(
  fig.align = "center",
  fig.retina = 6,
  warning = F,
  message = F,
  cache = FALSE,
  echo = F,
  error = T
)
```

```{r cache = F, include = F}
#--- packages ---#
library(tidyverse)
library(data.table)
library(officedown)
library(officer)
library(flextable)
library(stringr)
library(sf)
library(flextable)
```


# Introduction

Uniform input management strategies (e.g., applying the same nitrogen rate across an entire field) can lead to both economic losses and environmental inefficiencies [@fassa2022site]. A widely recognized solution is site-specific, or variable-rate, input management, which accounts for spatial heterogeneity in crop input demand [@fassa2022site; @malzer1996corn; @bullock1994quadratic; @puntel2016modeling; @wortmann2011nitrogen; @lobell2007cost; @termin2023dynamic; @wen2022optimizing]. Among emerging approaches, on-farm precision experiments (OFPE) is considered a promising approach. OFPE leverages GPS technologies and variable-rate applicators to implement input experiments where input rates are varied within the field [@paccioretti2021statistical]. Data collected—including yield, applied nitrogen, soil characteristics, and weather—are subsequently analyzed to estimate site-specific yield response functions, which serve as the basis for determining economically optimal nitrogen rates (EONR) at fine spatial scales [@de2023predicting; @morales2022generation; @li2023economic]. 

In recent years, machine learning approaches are increasingly used for estimating site-specific yield response functions [@barbosa2020risk; @barbosa2020modeling; @krause2020random; @gardner2021economic]. One of the key part of such process is to identify the best model among several candidate ML approaches and also tuning hyper parameters via cross-validation. In all of the previous studies, the best model was selected based on their abilities to predict yield level at the observation points (which we term as the yield-based model selection). However, the ultimate goal is not to predict yield levels, but to estimate yield response (causal marginal impact of nitrogen on crop yield). Indeed, @kakimoto2022causal shows that achieving high accuracy in yield prediction does not necessarily imply accurate yield response estimation, and thus EONR prediction. Empirical evidence further supports this idea, as studies have found that the correlation between EONR and the corresponding yield at EONR is weak [@morris2018strengths; @sawyer2006concepts; @vanotti1994alternative]. Therefore, it seems questionable to select the best model based on its ability to predict yield level instead of yield response when the ultimate goal is to provide most profitable variable rate input recommendation.

This article proposes an alternative to conventional yield-based model selection. Specifically, we select models based on their ability to predict local EONR using spatial cross-validation. To evaluate this approach, we conduct Monte Carlo simulations in the context of nitrogen rate application and compare its performance against the standard yield-based selection method. Our results show that the proposed approach is substantially more effective at identifying models that generate more profitable variable-rate nitrogen recommendation maps.


# Method

To test the effectiveness of our proposed model selection approach against the traditional yield-based model selection approach, we conduct Monte Carlo simulations of 1000 iterations.

A single iteration of our simulation follows the following steps:

+ Step 1: Generate OFPE experiment data
+ Step 2-1: Identify the true best (most profitable VRA application rate) model among the five candidate models
+ Step 2-2: Select the best model among the 5 candidate models based on
  + yield (conventional approach)
  + local-EONR (our approach)
+ Step 3: Evaluate the model selection approaches


Steps 2-1 and 2-2 use data generated in Step 1, but are implemented independently, with no interdependency. They do not necessarily have to be performed in a specific order. Step 3 relies on the results of Steps 2-1 and 2-2. When referring to these steps, we use their designated names (e.g., Step 1). The five candidate models we consider are linear model, linear spatial error model, random forest, boosted regression forest, and causal forest.


## Data generation (Step 1)

### Simulated experimental field

The data for this study was generated from a simulated corn production field with spatially varying field characteristics. The field was 432m wide and 864m long, making about 37.3 hectares in total area. Figure @field-map illustrated one possible scenario of the spatial variability in the field characteristics, where the spatial resolution of the variability is the basic unit of the 6m × 6m "cell".

```{r}
#| label: field-map
#| fig-cap: "Illustration of the simulated on-farm precision experiment (OFPE) field."

knitr::include_graphics("figures-tables/field_map.png")
```

An on-farm precision experiment (OFPE) of corn yield response to N rates was conducted in this simulated field. The spatial unit of the N trial rates application was, however, much larger than the basic cell unit. It was assumed to be 18m wide and 72m long (or 3 cells × 12 cells), referred to as a "plot." The choice of this plot dimension was to accommodate the width and application accuracy of the commercial variable-rate applicators currently used on the market. The true yield data varied at the basic cell resolution, but in practice the yield monitoring system can hardly achieve that accuracy level. This study assumed the yield data were collected at the 18m × 12m (3 cells × 2 cells) unit, referred to as a "subplot." The selection of 18m as the width of yield data unit, which equals the width of the N rate plot, is mainly for the convenience of data generating process. The selection of 12m length of yield data unit is based on the fact that the current yield monitoring system usually required the harvester to run about 12m to ensure accurate yield data. In addition, a 12m "transition zone" was put between two adjacent N plots, giving the harvester sufficient time to adapt the N trial rate change between plots. After excluding the transition zones, each N plot consisted five effective yield subplots for data analysis. A detailed layout map of the field that illustrated the spatial units of "cell", "subplot", and "plot" was displayed in Figure @field-map. In total, the effective experimental data generated from the simulated OFPE field included 288 N plots, 1440 yield subplots, and 8640 cells.

### True yield responses

The true yield at a specific cell was assumed to be generated following the quadratic-plateau functional form:

$$
y_{j, i}=f_{j, i}(N)= \begin{cases}\alpha_{j, i}+\beta_{j, i} N+\gamma_{j, i} N^2+\varepsilon_{j, i}, & N<\tau_{j, i} \\ \eta_{j,i}+\varepsilon_{j, i}, & N \geq \tau_{j, i}\end{cases}
$$ {#eq-yield-response}

where the index $j \in{1,\ 2,\ 3,...,1440}$ denoted the subplot, $i \in{1,\ ...,6}$ denoted the cell within a subplot, and the couplet $(j, i)$ uniquely identified an individual cell. The response parameters $\alpha_{j, i}$, $\beta_{j, i}$ and $\gamma_{j, i}$ represented the intercept (i.e., zero-N yield), linear, and quadratic coefficients of the yield responses. The parameter $\tau_{j, i}$ represented the N rate at which the yield reaches a plateau. Parameter $\eta_{j,i}$ denotes the yield at $N = \tau_{j, i}$. The stochastic error term $\varepsilon_{j, i}$ followed a normal distribution and exhibits spatial autocorrelation. The quadratic-plateau functional form implies a diminishing marginal return of N until a yield plateau is reached, a common pattern of corn yield response observed in agronomic studies @frank1990comparison. The true economically optimal N rate for each cell $(j, i)$ was then determined by:


$$
N_{j, i}^* \equiv \operatorname{argmax}_N\left[p \cdot f_{j, i}(N)-w \cdot N\right]
$$ {#eq-true-eonr}

where $p$ denoted the crop price, $w$ denoted the nitrogen fertilizer price, and $f_{j, i}(N)$ was the previously defined true yield response function for the specific cell. 

Let $\mathbf{\theta}_{j,i}$ denote the set of cell-specific response parameters $\left(\alpha_{j, i}, \beta_{j, i}, \gamma_{j, i}, \tau_{j, i}, \eta_{j,i}\right)$^[Note that although there appeared five parameters $\left(\alpha_{j, i}, \beta_{j, i}, \gamma_{j, i}, \tau_{j, i}, \eta_{j,i}\right)$ in the response function, the "free" parameters were only three due to the two inherent restrictions between parameters as mentioned above.]. Note that $\mathbf{\theta}_{j,i}$ can be regarded as a representation of all soil, water and other field properties influencing yield response to N rates. The within-field spatial variability of those response parameters, as illustrated by Figure @field-map, were generated through Gaussian geo-statistical simulations using unconditional random fields. A total of 500 simulated fields were implemented using the R gstat [@graler2016spatio] package based on selected variogram parameters [@dietrich1996fast; @wood1994simulation]. 

The spherical variogram model was used in the geo-statistical simulations where the range was 600m and nugget was zero. The range value implied the cells' values were still spatially dependent within 600m, or in other words, cells' value would not differ abruptly over distance shorter than 600m. Zero nugget value indicated zero covariance when two cells distance approached zero. The sill of each response parameter was set accordingly such that the true economically optimal N rates ranged from 113 kg/ha to 273 kg/ha across simulations, the average of the simulated yield was 11,416 kg/ha, and the mean value of simulation yield error terms ($\varepsilon_{j, i}$) was 1,370 kg/ha. Those results were comparable with the empirical data collected from on-farm precision experiments from eight corn production fields conducted by the Data-Intensive Farm Management Project (DIFM) in 2018 [@bullock2019data], which justified the simulated data were roughly realistic.


### Experimental design

Six trial N rates are used in each simulated on-farm experiment. In a given iteration, the $0\%$, 20\%$, 40\%$, 60\%$, $80\%$, and $100 \%$ quantiles of the true cell-specific plateau N rates ($\tau_{j, i}$) are obtained. Letting $Q(x)$ denote the $x\%$ quantile, the six N rates are set to be $\{Q(0) - 20, Q(20), Q(40), Q(60), Q(80), Q(100) + 20\}$. Note that 20 kg/ha was substracted from $Q(0)$ and 20 kg/ha was added to $Q(100)$. This ensures the minimum and maximum trial N rates would fully cover the true plateau points of all the cells. Each simulation's trial N rates differ slightly across iterations as each iteration has differing range of true optimal N rates. The average trial N rates across 500 simulations are approximately $\{80, 130, 154, 184, 219, 270\}$ kg/ha.

The spatial allocation of the six N trial rates followed a 6 × 6 Latin square design. The whole experimental field was into 8 (= 4 × 2) blocks, each block including 36 (= 6 × 6) N plots to establish the Latin square design. Each of the six N rates was assigned to one plot in every row and column of the Latin square. Specifically, the N rate allocation followed a distinctive pattern [@li2023economic] such that any large, abrupt changes in N rates between adjacent plots were avoided along the row direction (i.e., the direction of N fertilizer application). This trial design accommodated the accuracy limitations of N application equipment commonly observed in real-world production, and also had superior economic performances compared to other trial designs [@li2023economic]. The experimental design from one example simulation is shown in Figure @Nrate-yield (left panel). 

```{r}
#| label: Nrate-yield
#| fig-cap: "Experimental design of six nitrogen rates (left) and observed yield data (right)."

knitr::include_graphics("figures-tables/Nrate_yield.png")
```

### Yield data

Based on the experimental design, response parameters ($\mathbf{\theta}_{j,i}$), and error term $\varepsilon_{j,i}$, the yield $y_{j, i}$ for each cell $(j, i)$ was generated following the true response function in Equation eq-yield-response. However, as mentioned earlier, the harvesting equipment was assumed to be able to accurately collect yield data only at the 18m $\times$ 12m (subplot) resolution. Therefore, the observed yield data were at the resolution of subplot level, denoted as $y_j$ ($j=1, \ldots, 1440$). Here we assumed $y_j$ is the average yield for the six cells within the subplot $j$. The observed yield map for the 1440 subplots in one example simulation was displayed in Figure @Nrate-yield (right panel).

Note that N trial rate was applied at the much larger plot unit, and therefore each subplot $j$'s N rate was simply the N rate of the applied plot that subplot $j$ fell into, which can be denoted as $N_j$. In each simulation, the 1440 subplot-level observed yield and N rate data $\left(y_j, N_j\right)$ were used for data analysis. 


### Observed field characteristics (independent variables) 

It is important to note that the true response parameters ($\mathbf{\theta}_{j,i}$) and economically optimal N rates $N_{j, i}^*$ are not directly observable by producers or researchers. Instead, what can be observed in the real world are some field characteristics data that may be correlated with those true parameters. This study emulated this real-world limitations by creating some covariates to serve as the observable field characteristics.

Yield-maximizing N rate ($\tau$) was split additively into $\tau^1$ and $\tau^2$ in random and spatially correlated manner:


```{=tex}
\begin{align}
\tau_{j,i} = \tau_{j,i}^1 + \tau_{j,i}^2 \label{eq-tau-additive}
\end{align}
```

Furthermore, $\tau_{j,i}^1$ and $\tau_{j,i}^2$ are further decomposed in the same additive, random, and spatially correlated manner. 

```{=tex}
\begin{align}
\tau_{j,i}^1 = \tau_{j,i}^{1,1} + \tau_{j,i}^{1,2}, \hspace{0.5cm} \tau_{j,i}^2 = \tau_{j,i}^{2,1} + \tau_{j,i}^{2,2} \label{eq-tau-additive-second}
\end{align}
```

Models are asked to discover the additive structure based on the four independent variables $\tau_{j,i}^{1,1}$, $\tau_{j,i}^{1,2}$, $\tau_{j,i}^{2,1}$, and $\tau_{j,i}^{2,2}$ to recover or approximate $\tau_{j,i}$ along with other parameters while recovering the true yield response function.

The coefficient on $N$ ($\beta$) was split in the same manner as $tau$.

```{=tex}
\begin{align*}
\beta = \beta^1 + \beta^2, \hspace{0.5cm} 
\beta^1 = \beta^{1,1} + \beta^{1,2}, \hspace{0.5cm} \beta^2 = \beta^{2,1} + \beta^{2,2} \label{eq-beta-split}
\end{align*}
```

Yield plateau ($\eta$) were decomposed in a different way: 

```{=tex}
\begin{align*}
\eta = min(\eta^1, \eta^2), \hspace{0.5cm} 
\eta^1 = min(\eta^{1,1}, \eta^{1,2}), \hspace{0.5cm} \eta^2 = min(\eta^{2,1} + \eta^{2,2}) \label{eq-eta-min}
\end{align*}
```

The four independent variables ($\eta^{1,1}_j$, $\eta^{1,2}_j$, $\eta^{2,1}_j$, $\eta^{2,2}_j$) are spatially correlated. This decomposition is highly non-linear unlike the decomposition of $\tau$ and it is likely harder for linear models to discover $\eta$ than the non-parametric ML models.

Those covariates were first generated in the cell unit, and then aggregated to the subplot unit to serve as the observed "field characteristics" data, denoted as $X_j = \left(\beta^{1,1}_j, \beta^{1,2}_j, \beta^{2,1}_j, \beta^{2,2}_j, \tau^{1,1}_j, \tau^{1,2}_j, \tau^{2,1}_j, \tau^{2,2}_j, \eta^{1,1}_j, \eta^{1,2}_j, \eta^{2,1}_j, \eta^{2,2}_j \right)$. $X_j$ is used as the covariates in yield response estimation. Note that $X_j$ contained sufficient information to estimate the true yield response function even though $X_j$ does not include $\alpha$ and $\gamma$. The following two equations hold for the five parameters:

```{=tex}
\begin{align*}
\tau_{j, i} & =-\beta_{j, i}/(2\gamma_{j, i}) \\
\eta_{j,i} & = \alpha_{j, i}+\beta_{j, i} \tau_{j, i}+\gamma_{j, i} \tau_{j, i}^2
\end{align*}
```

Consequently, the degrees of freedom of the true yield response function is three (5 parameters, two equations). Therefore, once three of the five parameters are known, then the rest will be automatically known.



## Identify the true best model among the five candidate models (Step 2-1)

In this step, each of the candidate models are trained using the whole experiment data and then variable rate EONR are estimated for the whole field. Then, the estimated variable rate N recommendations are evaluated against the **true** variable rate N to evaluate the performance of the models.

<!-- Both steps 2-1 and 2-2 involves yield response and variable rate EONR estimation for each of the candidate models even though they differ in training data and the target dataset for which site-specific EONR are estimted (hereafter target data).  -->

Here, we first detail how each of the candidate models is trained and how the site-specific EONRs are estimated based on the trained model subsequently. In all the models, the dependent variable is corn yield ($y_i$) and the same set of variables ($N_i$, $\alpha_i$, $\beta_i$) are used as the independent variables.

### Model training

For all the models, the same set of independent variables are used to train them: $N$ and $X$. 

#### Linear and spatial error models

Yield response function is parametrically estimated for linear model (LM) and spatial error model (SE). The LM approach estimates the following quadratic model:

```{=tex}
\begin{align*}
y_i = \alpha + \lambda_1 N_i +  NX_i \lambda_2 + \lambda_3 N^2_i + N^2X_i\lambda_4  + X_i\lambda_5 + v_i
\end{align*}
```

In this model, $NX_i$ is a vector of the interaction of $N$ and $X$ (i.e., $N_i\tau^{1,1}_i$, $N_i\tau^{1,2}_i$, ..,) and $\lambda_2$ are their respective coefficients. $N^2X_i$ is a vector of the interaction of $N^2$ and $X$ (i.e., $N^2_i\tau^{1,1}_i$, $N^2_i\tau^{1,2}_i$, ..,) and $\lambda_4$ are their respective coefficients. There interaction terms allow the marginal impact of $N$ to vary based on the observed characteristics $X$. Note that the model is intentionally misspecified. While we could have used the quadratic-plateau model, its estimation is highly numerically unstable with the number of independent variables. Also note that our objective is to test our model selection approach. The use of a suboptimal model as one of the candidates models do not compromise this objective. 

Spatial error (SE) model approach uses the same estimating equation, but recognizes the spatial correlation in the error term. Consequently, it is statistically more efficient than the LM approach, which in turn is more likely to result in more accurate variable rate EONR estimation subsequently.

Once the model is trained, site-specific EONR can be found by the following closed form equation for both the LM and SE approaches:

```{=tex}
\begin{equation}
\hat{N}^*_i = (\frac{P_N}{P_C} - \lambda_1 - X_i\lambda_2)/2(\lambda_3+X_i\lambda_4)
\end{equation}
```

where, $P_C$ and $P_N$ represent corn and nitrogen prices, respectively. 

#### Random Forest (RF) and Boosted Regression Forest (BRF)

For, random forest (cite) and boosted regression forest (cite), yield response functions are non-parametrically estimated without any functional form assumptions unlike the LM and SE approaches. They are well known to be better at predicting yield **levels** compared to traditional linear models, their ability to estimate the marginal impact of input on crop yield can be questionable (cite).

Let $\widehat{f}(N, X)$ denote the estimated yield response function from either of the approaches. Then, variable rate EONRs are calculated numerically by solving the following profit maximization problem at each site ($i$) of the field:

$$
\hat{N}^*_i =  argmax_{N}\;\; P_c \hat{f}(N, X_i) - P_N N
$$

#### Causal Forest (CF)

Causal forest focuses on identifying the causal heterogeneous impacts of a treatment (changes in N rate here) unlike RF and BRF, which focus on predicting yield levels. For this reason, it has been shown to perform better than them in estimating site-specific EONR [@kakimoto2022causal].

Let, $N_k$ indicate $k$ th lowest N experimental rates ($N_1$ is the lowest, and $N_5$ is the highest). In the CF approach, four treatments are defined where the lowest rate (N_1) serves as the base line: $N_2$ vs $N_1$, $N_3$ vs $N_1$, $N_4$ vs $N_1$, and $N_5$ vs $N_1$. Let $T_k$ indicate the treatment of $N_k$ vs $N_1$. Then the multia-arm^[This simply means that multiple heterogeneous treatment effects are estimated in a single model.] CF model is written as follows:

```{=tex}
\begin{align*}
y_i = \sum_{i=2}^5 \theta_k(X_i)\cdot T_k + g(X_i)
\end{align*}
```

In this equation, $\theta_k(\alpha_i, \beta_i)$ represents the heterogenous treatment effect of $T_k$ as a function of site-specific characteristics $\alpha_i$ and $\beta_i$. For example, $\theta_2(\alpha_i, \beta_i)$ represents the impact of increasing N level from $N_1$ to $N_2$ at the observed soil characteristic values. The final term, $g(\alpha_i, \beta_i)$, represents the direct impact of $\alpha_i$ and $\beta_i$ (not through a change in N rate).

Unlike the rest of the approaches, the estimated CF model cannot predict yield levels, rather it predicts the impact of treatments (changes in N rate). 

```{=tex}
\begin{align*}
y_i|_{N_k} - y_i|_{N_1} = \theta_k(X_i)
\end{align*}
```

Then, the change in profit from increasing N rate from $N_1$ to $N_k$ for site $i$ is

```{=tex}
\begin{align*}
P_C\cdot \theta_k(X_i) + P_N \cdot (N_k - N_1)
\end{align*}
```

The EONR for site $i$ is $N_k$ that produces the highest positive profit differential unless all the profit differentials are negative, in which case, $N_1$ is the EONR.

### True model performance {#sec-true-model}

We use profit loss relative to the true site-specific EONR as the criteria for model performance as that is farmers' ultimate objective. The average per-acre profit from true site-specific EONR (denoted as $\pi_{true}$) is

```{=tex}
\begin{align*}
\pi_{true}  = \frac{1}{N}\cdot \sum_{i=1}^{N} [P_c \cdot f(N^*_i, X_i) - P_N \cdot N^*_i]
\end{align*}
```

This represents the maximum profit achievable average per-acre profit if you were to know the true site-specific EONR.

The average profit per acre associate with the site-specific N prescription by model $m$ (denoted as $\pi_m$), which is defined as

```{=tex}
\begin{align*}
\pi_m  = \frac{1}{N}\cdot \sum_{i=1}^{N} [P_c \cdot f(\widehat{N}^*_{m}(X_i), X_i) - P_N \cdot \widehat{N}^*_{m}(X_i)]
\end{align*}
```

Then the profit loss of model $m$ relative to the true maximum profit achievable (denoted as $\pi-loss_{m}$) is then defined as

```{=tex}
\begin{align*}
\Delta\pi_m  = \pi_{true} - \pi_m
\end{align*}
```

The lower the value of $\Delta\pi_m$, the better. We would like a model selection approach that is capable of selecting the true best model identified here. 

## Model Selection (Step 2-2)

We implement two model selection approaches: one based on yield prediction accuracy and the other based on local EONR prediction accuracy. For both approaches, spatial cross-validation is employed. The entire dataset is randomly split into a train and test dataset in a spatially clustered manner, which is repeated to create multiple folds as depicted in @fig-fold-example. 

```{r}
#| label: fig-fold-example
#| fig-cap: "An example of the train-test split for each of the five folds."

knitr::include_graphics("figures-tables/g_split_example.png")
```

This process is repeated multiple times to create more folds. @tbl-fold-repeat presents the the complete set of combinations of the number of folds and repeats that are tried in our simulation analysis. As our main results, we present the results with case 5 (# of folds = 10 and # of repeats = 5) in @sec-results-main. @sec-results-sensitivity-fold-repeat will discuss how the choice of fold-repeat affect the performance of the model selection approaches.

```{r}
#| label: tbl-fold-repeat
#| tbl-cap: "List of fold-repeat combinations"
 
accuracy_table <- readRDS("figures-tables/selection_accuracy_table.rds")

num_folds <- accuracy_table[, unique(num_folds)]
num_repeats <- accuracy_table[, unique(num_repeats)]

data.table::CJ(
  num_folds = num_folds,
  num_repeats = num_repeats
) %>%
  .[, total_num_folds := num_folds * num_repeats] %>%
  .[, case := 1:.N] %>%
  .[, .(case, num_folds, num_repeats, total_num_folds)] %>%
  flextable() %>%
  align(j = 1:3, align = "center") %>%
  set_header_labels(
    values = list(
      case = "Case",
      num_folds = "# folds",
      num_repeats = "# repeats",
      total_num_folds = "total # of folds"
    )
  ) %>%
  autofit()
```

### Model selection based on yield level prediction

Let $f$ and $F$ indicates a fold and the total number of folds, respectively. For each of the candidate models, the following steps are implemented for each fold:

1. train the model using the train data of the fold
2. predict yield for each of the observations in the the test data based on the trained model ($\hat{y}_{i,f}$)
3. calculate RMSE of yield prediction as $RMSE-Yield_{m,f} = \sqrt{\sum_{i=1}^{N_t}(\hat{y}_{i,f} - y_{i, f})^2/N_t}$

Once this process is completed for all folds, the average RMSE for yield prediction is calculated for the model. 

```{=tex}
RMSE-Yield_{m} = \sum_{f=1}^F RMSE-Yield_{m, f}
```

This process is repeated for all the models, and the model with the lowest average RMSE is selected.

### Model selection based on local EONR 

In selecting a model for EONR prediction, it would be ideal if we could assess models based on their ability to estimate site-specific EONRs rather than yields because our ultimate interests lie in estimating EONRs, not crop yield levels. Of course, this is simply impossible because the true EONRs are never observable in the real world setting unlike crop yield. Our model selection approach attemps to overcome this challenge by validating models on "local uniform EONR" estimated by a statistical model in place of unobservable true EONR. In other words, we treat the estimated local EONR as the proxy for the true local EONR and select models that are capable of predicting the estimated local EONRs the best. Clearly, for our approach to perform well, it is vital that the estimation of local EONR is accurate enough. In this study, we will use the GAM model to find local EONR because it can estimate yield response function without making any functional form assumptions. We first lay out the entire process and then provide details of the steps.

For each fold and a given candidate model, the following steps are performed:

1. train the GAM model using the **test** data 
2. estimate uniform EONR for the **test** data ($\hat{N}^*_{f,gam}$)
3. train the candidate model using the **train** data 
4. estimate site-specific EONR for the **test** data based on the trained candidate model ($\hat{N}^*_{i, f,m}$). 
5. calcurate the average of the site-specific EONR from the step above ($\hat{N}^*_{f,m}$)

Once the above processes are completed for all folds, then the RMSE of estimating local EONR is calculated for the as follows:

```{=tex}
\begin{align}
RMSE-LE_{m} = \sqrt{\sum_{f=1}^F (\hat{N}^*_{f,m} - \hat{N}^*_{f,gam})^2 / F}
\end{align}
```

In step 1, the following GAM model is estimated:

```{=tex}
\begin{align*}
y_i = \sum_{j=1}^J \delta_j \phi_j(N_i)+ \varepsilon_i
\end{align*}
```

where $\phi_j(N_i)$ is $j$ th spline basis and $\delta_j$ is its coefficient. Collectively, $\sum_{j=1}^J \delta_j \phi_j(N_i)$ represents the the impact of N on corn yield. The model does not assume any functional form for the relationship between corn yield and N. Please note that neither $\alpha_i$ or $\beta_i$ are included as independent variables. It makes no attempt to identify interactive impact of N with $\alpha_i$ or $\beta_i$. It is important to keep the model simple to make the estimation task light-weighted so that it can estimate yield response function reasonably well with relatively small sample size of the test data.

Once the GAM model is trained, unfiorm (not variable) EONR is obtained by numerically solving the profit mamization problem. We call the estimated EONR "local EONR" because it is local to the test data. While the GAM model does not consider $\alpha_i$ or $\beta_i$ explicitly, the estimated yield response function embeds their information. For example, if the test data of a fold is located in a part of the field where soil characteristics are such that yield responds strongly to N, then that is reflected in the GAM's estimation of yield response in that area, and so are the estimated Local EONR.

Once the GAM model is trained, a uniform (not variable) EONR is obtained by numerically solving the profit maximization problem. We refer to the estimated EONR as "local EONR" because it is specific to the location of the test data. While the GAM model does not explicitly account for $\alpha_i$ or $\beta_i$, the estimated yield response function inherently captures their effects. For instance, if the test data for a given fold corresponds to a region of the field where soil characteristics lead to a strong yield response to nitrogen, this influence is embedded in the GAM’s estimation of the yield response for that area and, consequently, in the estimated local EONR. If a candidate model that explicitly accounts for the interaction between nitrogen and soil characteristics produces a similar local EONR, it indicates the model’s ability to statistically identify these interactive effects.

Steps 3 and 4 are exactly the same as Step 2-1 except that the candidate models are trained on the train data of the fold and site-specific EONR are estiamted for the test data of the fold.

## Evaluation of model selection performance (Step 3) {#sec-selection-performance}

Let $m^*$ denote the true best model for a given simulation iteration identified as explained in @sec-true-model. Further, let $\widehat{N}^*_{m^*}(X_i)$ denote the EONR for cell $i$ estimated based on the best model ($m^*$). Then the highest profit that could be achieved for this field is:


```{=tex}
\begin{align*}
\pi_{m^*}  = \frac{1}{N}\cdot \sum_{i=1}^{N} [P_c \cdot f(\widehat{N}^*_{m^*}(X_i), X_i) - P_N \cdot \widehat{N}^*_{m^*}(X_i)]
\end{align*}
```

Now let $m^{s}$ and $\widehat{N}^*_{m^s}(X_i)$ denote the model selected by model selection approach $s$ and the EONR for cell $i$ estimated based on the model. Then the profit achieved by this model is:

```{=tex}
\begin{align*}
\pi_{m^s}  = \frac{1}{N}\cdot \sum_{i=1}^{N} [P_c \cdot f(\widehat{N}^*_{m^s}(X_i), X_i) - P_N \cdot \widehat{N}^*_{m^s}(X_i)]
\end{align*}
```

Their difference, $\pi_{m^*}$ - $\pi_{m^s}$, measures the economic performance of the model selection approach. The difference is always positive by construction. The smaller the difference is, the better the model selection approach has performed. For example if the model selection approach picks the same model as the true best model, then the profit difference is zero. 


# Results and Discussions {#sec-results}

```{r}
# accuracy_table <- readRDS("GitControlled/Writing/figures-tables/selection_accuracy_table.rds")

main_table <- accuracy_table[num_folds == 10 & num_repeats == 5, ]

num_se_by_leonr <- main_table[method == "SE", num_selected_leonr]

num_se_by_leonr_correct <- main_table[method == "SE", num_selected_leonr_correct]

num_se_true <- main_table[method == "SE", num_selected_true]

num_lm_true <- main_table[method == "LM", num_selected_true]

num_all_by_lenor_correct <- main_table[, sum(num_selected_leonr_correct)]

num_lm_by_lenor <- main_table[method == "LM", num_selected_leonr]

num_lm_by_lenor_correct <- main_table[method == "LM", num_selected_leonr_correct]

num_brf_by_yield_correct <- main_table[method == "BRF", num_selected_yield_correct]

num_brf_true <- main_table[method == "BRF", num_selected_true]
```

## Performance of the model selection approaches {#sec-results-main}

@fig-selection-performance presents the number of times models are selected by the two model selection approaches and also selected as the actual best performing model. Yield-based model selection approach selected BRF for all the 500 simulation rounds. However, BRF was actually the best model in only `r num_brf_true` rounds. Among the candidate models, the linear spatial error model was the best most often at `r num_se_true` rounds. Our model selection approach, on the other hand, selects SE as often as it is selected as the actual best. Our model selection approach tends to select BRF much less than it is chosen as the actual best. 

```{r}
#| label: fig-selection-performance
#| fig-cap: "Frequency of models selected by the two selection approaches and selected as the actual best (lowest RMSE of site-specific EONR prediction)"
knitr::include_graphics("figures-tables/g_ranking.png")
```

@tbl-accuracy-table provides a deeper insights into the performance of the model selection approaches. Numbers in parenthesis indicate the number of times the model is selected. For example, the LEONR-based approach selected the SE model `r num_se_by_leonr` times. Numbers to the left of parenthesis indicates the number of times the model is correctly selected, meaning that a selection approach selected the model that indeed performed the best. For example, among the `r num_se_true` times the SE model performed the best, the LEONR-based approach selected the SE model correctly `r num_se_by_leonr_correct` times. The LEONR-based approach selected the liner model `r num_lm_by_lenor` times, but its choice was correct only `r num_lm_by_lenor_correct` times. In total, the LEONR-based approach correctly selected the best model `r num_all_by_lenor_correct` times. The yield-based approach selected the BRF model for all the simulation rounds, while its choice is correct only `r num_brf_by_yield_correct` times. Overall, the LEONR-based approach performs far better than the yield-based approach.

```{r}
#| label: tbl-accuracy-table
#| tbl-cap: "Accuracy of the model selection approaches"
readRDS("figures-tables/main_selection_accuracy_table.rds")
```

Even when a selection approach selects a model that is not the best in predicting site-specific EONR, the selection approach is considered performing well as long as its site-specific EONR is similar to that of the true model because the selected model would achieve a similar level of profit as that from the best model in such a circumstance. @fig-profit-loss presents the distribution of the loss in profit relative to the actual best model defined in @sec-selection-performance. For example, if a selection approach correctly selects the best model, then the profit loss for that round would be zero. However, if a selection approach selects a sub-optimal model and its site-specific EONR recommendation make $10/acre less than the profit generated by the recommendation from the best model, then the profit loss for that round is $10/acre. Since agricultural producers' ultimate interest lies in the profitability, this measure is more relevant than the frequency of correctly secting the best model. As can be seen in the figure, the LEONR-based selection would result in a much smaller profit loss (much higher profit) compared to the yield-based selection.

```{r}
#| label: fig-profit-loss
#| fig-cap: "Distribution of profit loss associated with the seleted models relative to the actual best models"
knitr::include_graphics("figures-tables/g_pi_loss.png")
```

## Accuracy of Local EONR estimation with GAM

Our selection approach replaces true yet unobservable local EONRs with local EONRs estimated by GAM. Therefore, it goes without saying that the accuracy of local EONR estimation by GAM is critical for our selection approach. @fig-cor-gam-leonr presents the scatter plots of true LEONR (y-axis) and estimated LEONR (x-axis) for all the folds generated for the 500 simulations. While there are two clusters of GAM-estimated local EONRs that over- and under-estimate the true local EONRs, the vast majority of the data points are located around the 1-to-1 line (red dotted line), indicating the usefulness of GAM-based estimation of local EONR in our model selection approach. Our selection approach used GAM because it is capable of capturing the functional form of yield response to nitrogen without any functional form assumptions unlike quadratic or quadratic-plateaur functional forms typically used in empirical studies. However, our model selection approach is of course not just limited to GAM, and it may be worthwhile to explore other statistical approaches as a way to estimate LEONR in future studies.

```{r}
#| label: fig-cor-gam-leonr
#| fig-cap: "GAM vs True EONR"

knitr::include_graphics("figures-tables/g_gam_leonr.png")
```

## The impact of different fold-repeat combination on local EONR selection and yield selection method {#sec-results-sensitivity-fold-repeat}

```{r}
#| label: fig-fold-repeat
#| fig-cap: "The impact of different fold-repeat combinations on the performance of the model selection approaches based on local EONR and yield"

knitr::include_graphics("figures-tables/g_sensitivity_fold_repeat.png")
```

@fig-fold-repeat presents a comparison of two model selection criteria: local EONR and yield-based, across various combinations of folds and repeats. The x-axis represents the ranking of the ML models in estimating true site-specific EONRs, with rank 1 indicating the best-performing model in estimating site-specific EONRs compared to the true EONRs.

In the context of local EONR model selection, the y-axis depicts the frequency of selecting the right model. The local EONR criterion consistently demonstrated an increasing trend in accuracy as the number of folds and repeats increased. For example, with 5 folds and 1 repeat, the correct model was selected in approximately 57.2 percent of simulations. This success rate improved to 58.4 percent with 5 repeats, and further to 62.4 percent with 7 folds and 5 repeats. Notably, increasing the number of folds to 10 while maintaining 5 repeats resulted in a substantial improvement, achieving a success rate of 65.8 percent. The pattern continued across different combinations, such as 5 folds and 10 repeats (59.4 percent success) and 10 folds and 10 repeats (65.2 percent success). This consistent improvement in accuracy underscores the positive impact of increasing the number of folds and repeats on the local EONR model selection.

In contrast, the yield-based model selection exhibited a lower success rate in identifying the best-performing model for EONR estimation. Across all combinations of folds and repeats, the yield-based method consistently achieved a success rate of approximately 14.2-14.4 percent. This low success rate remained largely unaffected by variations in the number of folds and repeats. Consequently, it can be inferred that altering the fold and repeat parameters did not significantly influence the performance of the yield-based model selection in accurately identifying the optimal model for EONR estimation.

The findings from these two model selection criteria highlight a clear distinction in their responses to different combinations of folds and repeats. While the local EONR criterion exhibited a notable increase in accuracy as folds and repeats were increased, the yield-based model selection method consistently demonstrated limited effectiveness across all scenarios.

## Was our approach just lucky?

```{r}
accuracy_table_nosp <- readRDS("figures-tables/selection_accuracy_table_no_sp.rds")

se_best <- accuracy_table_nosp[method == "SE", num_selected_true]

lm_best <- accuracy_table_nosp[method == "LM", num_selected_true]
```

@tbl-accuracy-table-no-sp presents the accuracy of the model selection approaches when the field parameters have minimal spatial correlation. Even though such data is rater unrealistic in the OFPE context, it illustrates the power of our model selection approach. When field parameters are only slightly spatially correlated, the statistical advantage of the SE approach over LM approach diminishes substantially compared to the case with high spatial correlation. As a result, SE is the best model only `r se_best` times and LM is the best model `r lm_best` times while they are the best models `r num_se_true` and `r num_lm_true` times in our main results with high spatial correlation of field parameters, respectively. Our model selection approach had a harder time selecting the best model, selecting the LM model much more often. Note that this is not necessarily bad as selecting the model that is a close second does not lead to substantial economic loss. Indeed, our model selection approach results in similar economic performance, still far outperforming the yield-based selection approach as can be seen in @fig-economic-loss-no-sp. The most important, the contrast of the two cases with different level of spatial correlations shows that our model selection approach responds correctly to the subtlety of the statistical advantage SE approach brings when the spatial correlation is high.

```{r}
#| label: tbl-accuracy-table-no-sp
#| tbl-cap: "Accuracy of the model selection approaches when the field parameters are not highly spatially correlated."

readRDS("figures-tables/selection_accuracy_table_no_sp_ft.rds")
```


```{r}
#| label: fig-economic-loss-no-sp
#| fig-cap: "Distribution of profit loss associated with the seleted models relative to the actual best models when the field paramters are not highly spatially correlated"

knitr::include_graphics("figures-tables/g_pi_loss_nosp.png")
```

# Conclusion


\newpage

# References

::: {#refs}
:::

\newpage


