---
title: "A new model selection approach based on local economically optimal input rate"
author:
  - Mona Mousavi^[University of Nebraska Lincoln, mmousavi2@huskers.unl.edu], Taro Mieno^[University of Nebraska Lincoln, tmieno2@unl.edu],  David S. Bullock^[University of Illinois, dsbulloc@illinois.edu]
format: 
  html: default
  docx: default
bibliography: PA.bib
csl: computers-and-electronics-in-agriculture.csl
abstract: ""
---

```{r echo = F, cache = F, include = F}
library(knitr)

opts_chunk$set(
  fig.align = "center",
  fig.retina = 6,
  warning = F,
  message = F,
  cache = FALSE,
  echo = F,
  error = T
)
```

```{r cache = F, include = F}
#--- packages ---#
library(tidyverse)
library(data.table)
library(officedown)
library(officer)
library(flextable)
library(stringr)
library(sf)
library(flextable)
```

```{r, eval = FALSE}
# create figures and tables by running 3_present_results.rmd

knitr::purl("../Codes/3_present_results.rmd")
source("../Codes/3_present_results.R")
```



# Introduction

In conventional agriculture, the natural spatial variations within a field are disregarded, and the entire area is managed uniformly. However, implementing uniformly spatial nitrogen management can result in economic and environmental inefficiencies [@fassa2022site]. One potential solution to address this issue involves implementing site-specific (variable rate) nitrogen application techniques that can recognize spatially heterogeneous crop nitrogen demand [@fassa2022site; @malzer1996corn]. Such  management practices can improve the profits of production while reducing its environmental impacts [@bullock1994quadratic; @puntel2016modeling; @wortmann2011nitrogen; @lobell2007cost; @malzer1996corn; @termin2023dynamic; @wen2022optimizing]. 

A variety of methods have been developed to provide site-specific nitrogen recommendations. These methods include yield goal-based N recommendations, the Maximum Return to N (MRTN) [@ransom2019statistical] and the use of remote sensing techniques [@reussi2015using; @oliveira2013calibrating]. Other approaches to estimate EONR are crop simulation models [@miao2006evaluating]. Adapt-N [@melkonian2008adapt] and Maize-N [@setiyono2011maize] use computer simulation models for nitrogen recommendations. soil testing and nutrient analysis [@bundy1995soil] are also among other N recommendation approaches.

One of the emerging and promising approaches for providing site-specific N management is through on-farm precision experiments (OFPE). OFPE employs technologies like GPS and variable rate input applicators to conduct experimental designs and nitrogen trials within the field [@paccioretti2021statistical]. Subsequent to data collection and collation, including variables like yield, as-applied nitrogen, soil characteristics, and weather conditions, statistical analysis is performed to estimate site-specific yield response function, which then can be used to identify site-specific EONR [@de2023predicting; @morales2022generation; @li2023economic]. 


+ cross-validation is an indispensable step in selecting the model.
+ cross-validation is done by checking models' ability to predict the level of the dependent variable at the observed points.
+ in EONR estimation, we want the model that can estimate the slope of yield response function well, which is not observable.
+ this paper proposes a new model selection approach specifically for EOIR estimation. 
+ Briefly talk about our approach


Machine learning (ML) is a statistical tool for analyzing experimental data and providing site-specific EONR recommendations based on modeled yield responses to different inputs. When utilizing ML techniques to estimate site-specific EONRs from experimental data, it is important to recognize that the purpose of conducting experimental designs is to capture the variability of crop responses to input applications [@paccioretti2021statistical], forming the basis for EONR estimation. However, using ML to estimate EONRs requires caution. Several emerging studies [@barbosa2020risk; @barbosa2020modeling; @krause2020random; @gardner2021economic]  have employed ML techniques to predict site-specific EONRs using data from OFPE. However, they consistently select ML methods based on their ability to accurately predict yield. This raises a significant question, especially when the primary goal is to provide reliable site-specific EONR recommendations. A strong counterpoint to this practice is presented by @kakimoto2022causal. Through simulations, the study showed that achieving high accuracy in yield prediction does not necessarily imply accurate EONR prediction. This underscores the importance of understanding the causal relationship between treatment variables and crop yield. Empirical evidence further supports this idea, as studies have found that the correlation between EONR and the corresponding yield at EONR is weak [@morris2018strengths; @sawyer2006concepts; @vanotti1994alternative]. 

In this study, we use simulated data and apply ML techniques to propose a new approach for model selection to predict EONR. This approach is based on the spatial cross-validation and involves deriving yield responses to input variables in order to estimate local EONRs. Our inspiration for this method draws from the work of @de2023predicting. The approach uses spatial clustering to divide data into folds for training and testing. Within each fold, our candidate ML models estimate local EONR values. The performance of these estimates is evaluated by comparing them against a benchmark model using Root Mean Squared Error (RMSE). We further train the models on the complete dataset and rank them based on their RMSE in relation to the true EONR values. By comparing the rankings of locally estimated EONR values with the true values, we assess the performance of our local EONR model selection. Additionally, we evaluate the performance of a yield-based model selection approach. We found that the local EONR model selection approach consistently outperforms the yield-based model selection method when it comes to choosing a model for effectively predicting site-specific EONR.


# Materials and Method

To test the effectiveness of our proposed model selection approach against the traditional yield-based approach, we conduct Monte Carlo simulations of 1000 iterations.

A single iteration of our simulation follows the following steps:

+ Step 1: Generate OFPE experiment data
+ Step 2-1: Identify the true best (most profitable VRA application rate) model among the five candidates models
+ Step 2-2: Select the best model among the 5 candidate models based on
  + yield (conventional approach)
  + local-EONR (our approach)
+ Step 3: Evaluate the model selection approaches


Steps 2-1 and 2-2 use data generated in Step 1, but are implemented independently, with no interdependency. They do not necessarily have to be performed in a specific order. Step 3 relies on the results of Steps 2-1 and 2-2. When referring to these steps, we use their designated names (e.g., Step 1). The five candidate models we consider are linear model, linear spatial error model, random forest, boosted regression forest, and causal forest.


## Data generation (Step 1)

### Field layout

The experimental setup for the simulated on-farm precision experiment (OFPE) field involved the creation of a grid, where the fundamental spatial unit was a "cell" measuring 6m × 6m. This cell served as the resolution for varying field characteristics data, representing parameters of the "true" yield response function.

While the data resolution was at the 6m × 6m level, the practical monitoring of yields was set at a coarser resolution. The mechanical harvester, assumed to be 18m wide, required harvesting runs of at least 12m to ensure accurate yield data. Consequently, the yield data's resolution became 18m × 12m, forming a "subplot" consisting of 3 cells × 2 cells.

The application of N trial rates used an even larger unit, measuring 18m × 72m (3 cells × 12 cells), referred to as a "plot." This accommodated the variable-rate applicator's application resolution. A 12m "transition zone" was introduced between adjacent plots, allowing the harvester to adapt when the experimental N rate changed. Each N "plot" comprised five effective "subplots" for subsequent data analysis.

The overall dimensions of the field were 432m (72 cells) in width and 864m (144 cells) in length, resulting in a total area of 37.3 hectares. Data from the 6m-long headlands, side-lands (where no transition zones were present on the north and south ends), and 12m-wide "transition zones" were excluded from the analysis. In total, simulated data from 1440 subplots were utilized for data analysis. For identification purposes, the index $j \in{1,\ 2,\ 3,...,1440}$ represented the field's subplots, while the index $i \in{1,\ ...,6}$ denoted the cells within a subplot. The couplet $(j, i)$ was employed to uniquely identify individual cells. 

In our simulation, we assumed that the "true" yield response function for each cell $(j, i)$ followed the quadratic-plateau functional form: 
$$
y_{j, i}=f_{j, i}(N)=f\left(N, c_{j, i}\right)= \begin{cases}\alpha_{j, i}+\beta_{j, i} N+\gamma_{j, i} N^2+\varepsilon_{j, i}, & N<\tau_{j, i} \\ \alpha_{j, i}+\beta_{j, i} \tau_{j, i}+\gamma_{j, i} \tau_{j, i}^2+\varepsilon_{j, i}, & N \geq \tau_{j, i}\end{cases}
$$


The vector $c_{j, i}=\left(\alpha_{j, i}, \beta_{j, i}, \gamma_{j, i}, \tau_{j, i}\right)$ represents the yield response function parameters for each cell $(j, i)$. The parameter $\tau_{j, i}$ signifies the critical N rate at which the yield in cell $(j, i)$ reaches a plateau, indicating that further increases in N rate do not enhance yield. The stochastic error term $\varepsilon_{j, i}$ follows a normal distribution and exhibits spatial autocorrelation.

The quadratic-plateau functional form employed implies a diminishing marginal product of N until a yield plateau is reached. This characteristic is desirable for a yield response function, as highlighted by @frank1990comparison and aligns with patterns commonly observed in agronomic studies.

It's important to note that the cell-specific yield response function $f_{j, i}(N)$ is the reduced form of the meta response function $f$ when the characteristics vector takes on the value $c_{j, i}$. In simpler terms, all soil or field properties influencing yield response to N are encapsulated in the simulated parameters.

The spatial distributions of cell-level parameters $\alpha_{j, i}, \beta_{j, i}, \gamma_{j, i}, \tau_{j, i}$, and the error term  $\varepsilon_{j, i}$ were simulated through Gaussian geostatistical simulation using unconditional random fields. This simulation method, based on specified variograms [@dietrich1996fast; @wood1994simulation], was implemented using the R package gstat [@graler2016spatio]. 

The simulation model adopts a spherical structure with a range of 600 meters and a nugget variance of zero, indicating zero covariance for infinitesimally close observations. The choice of a 600m range was informed by empirical data from eight on-farm randomized N field trials conducted by the Data-Intensive Farm Management Project (DIFM) in 2018 [@bullock2019data]. A higher range value implies increased spatial dependence, reflecting less abrupt differences between production function parameters of neighboring cells.

The mean and sill variance of each parameter were set to achieve a realistic mean yield of 11416 $\mathrm{kg} \mathrm{ha}^{-1}$, and true economically optimal N rates ranged from 113 $\mathrm{kg} \mathrm{ha}^{-1}$ to 273 $\mathrm{kg} \mathrm{ha}^{-1}$ across simulations, aligning with real-world N rate recommendations. The error term $\varepsilon_{j, i}$'s magnitude was determined from empirical data of the DIFM project. Standard deviations of residuals from eight actual trials were used, resulting in a mean value of 1370 $\mathrm{kg} \mathrm{ha}^{-1}$, representing the square root of sill variances for the simulation's error terms.

Distinct spatial patterns of EONR emerged for each of the 500 Monte Carlo iterations, reflecting site-specific parameters and errors. It's noteworthy that while the spatial patterns vary, the parameters of the variogram (nugget and sill) remain consistent across simulations, ensuring uniform spatial dependence of site-specific parameters.

In each simulation, the "true" economically optimal N rate for each cell $(j, i)$ was determined using the expression:
$$
N_{j, i}^* \equiv \operatorname{argmax}_N\left[p \cdot f_{j, i}(N)-w \cdot N\right]
$$
Here, $p$ represents the crop price, $w$ represents the price of nitrogen fertilizer, and $f_{j, i}(N)$ is the yield response function for the specific cell. The goal is to find the value of N that maximizes the expression $p \cdot f_{j, i}(N)-w \cdot N$. 
It's important to note that these true economically optimal N rates $N_{j, i}^* \mathrm{s}$ are not directly observable by producers or researchers.

### Experimental Design

In each simulation of the on-farm experiment, the field layout followed a 4-block $\times$ 2-block grid configuration. Within each block, a 6-plot $\times$ 6-plot grid was established, employing a unique Latin square design. This design ensured that each of the six N rates was assigned to one plot in every row and column of the block.

The Latin square design, incorporating a distinctive pattern [@li2023economic], had the notable feature of preventing adjacent N plots from receiving the same N rate. Moreover, the order of N rates within each row of every block was carefully chosen to minimize abrupt changes in N rates. This consideration accounted for the practical limitations of N application equipment commonly observed in real-world OFPE.

In each simulation, six trial N rates were determined by calculating the $0 \%, 20 \%, 40 \%, 60 \%, 80 \%$, and $100 \%$ quantiles of the true cell-specific plateau N rates ($\tau_{j, i}$). Adjustments were made by subtracting 20 $\mathrm{kg} \mathrm{ha}^{-1}$ from the $0 \%$ quantile and adding 20 $\mathrm{kg} \mathrm{ha}^{-1}$ to the $100 \%$ quantile, ensuring that the trial N rates fully covered the true plateau points. The mean trial N rates across simulations were approximately {80, 130, 154, 184, 219, and 270} $\mathrm{kg} \mathrm{ha}^{-1}$, with negligible differences between simulations. 

### Yield data
In each simulation, the true yield $y_{j, i}$ for each cell $(j, i)$ was generated using the assigned application rate $N_{j, i}$, true response parameters $c_{j, i}=\left(\alpha_{j, i}, \beta_{j, i}, \gamma_{j, i}, \tau_{j, i}\right)$, and the error term $\varepsilon_{j, i}$. This process resulted in a field-level, cell-specific dataset represented as $\left\{\left(y_{j, i}, N_{j, i}\right): j=1, \ldots, 1440 ; i=1, \ldots, 6\right\}$. 

To align with real-world OFPEs, it was assumed that harvesting equipment could accurately record yields only at an 18m $\times$ 12m (subplot) resolution. Given that every cell within a plot received the same N application rate, it follows that $N_{j, 1}=N_{j, 2}=\cdots=N_{j, 6}=N_j$ for each subplot $j$. Letting $\mu_j$ denote the mean of yields for the cells in subplot $j$, the analysis of each round's data was based on 1440 $\left(\mu_j, N_j\right)$ observations.

## Identify the true best model among the five candidates models (Step 2-1)

In this step, each of the candidate models are trained using the whole experiment data and then variable rate EONR are estimated for the whole field. Then, the estiamted variable rate N recommendations are evaluated against the **true** variable rate N to evaluate the performance of the models.

<!-- Both steps 2-1 and 2-2 involves yield response and variable rate EONR estimation for each of the candidate models even though they differ in training data and the target dataset for which site-specific EONR are estimted (hereafter target data).  -->

Here, we first detail how each of the candidate models is trained and how the site-specific EONRs are estimated based on the trained model subsequently. In all the models, the dependent variable is corn yield ($y_i$) and the same set of variables ($N_i$, $\alpha_i$, $\beta_i$) are used as the independent variables.

### Model training

#### Linear and spatial error models

Yield response function is parametrically estimated for linear model (LM) and spatial error model (SE). The LM approach estimates the following quadratic model:

$$
y_i = \alpha_i + \lambda_1 N_i + \lambda_2 \alpha_i \cdot N_i + \lambda_3 \beta_i \cdot N_i + \lambda_4 N^2_i + \lambda_5 \alpha_i \cdot N^2_i + \lambda_6 \beta_i \cdot N^2_i + v_i
$$

Spatial error model uses the same estimating equation, but recognizes the spatial correlation in the error term. Consequently, it is statistically more efficient than the LM approach, which in turn is more likely to result in more accurate variable rate EONR estimation subsequently.

Once the model is trained, site-specific EONR can be found by the following closed form equation for both the LM and SE approaches:

```{=tex}
\begin{equation}
\hat{N}^*_i = 
\end{equation}
```

where, $P_C$ and $P_N$ represent corn and nitrogen prices, respectively. 

#### Random Forest (RF) and Boosted Regression Forest (BRF)

For, random forest (cite) and boosted regression forest (cite), yield response functions are non-parametrically estimated without any funcitonal form assumpations unlike the LM and SE approaches. They are well known to be better at predicting yield **levels** compared to traditional linear models, their ability to estimate the marginal impact of input on crop yield can be questionable (cite).

Let $\widehat{f}(N, \alpha, \beta)$ denote the estimated yield response function from either of the approaches. Then, variable rate EONRs are calculated numericaly by solving the following profit maximizationn problem at each site ($i$) of the field:

$$
\hat{N}^*_i =  argmax_{N}\;\; P_c \hat{f}(N, \alpha_i, \beta_i) - P_N N
$$

#### Causal Forest (CF)

Causal forest focuses on identifying the causal heterogeneous impacts of a treatment (changes in N rate here) unlike RF and BRF, which focus on predicting yield levels. For this reason, it has been shown to perform better than them in estimating site-specific EONR [@kakimoto2022causal].

Let, $N_k$ indicate $k$ th lowest N experimental rates ($N_1$ is the lowest, and $N_5$ is the highest). In the CF approach, four treatments are defined where the lowest rate (N_1) serves as the base line: $N_2$ vs $N_1$, $N_3$ vs $N_1$, $N_4$ vs $N_1$, and $N_5$ vs $N_1$. Let $T_k$ indicate the treatment of $N_k$ vs $N_1$. Then the multia-arm^[This simply means that multiple heterogeneous treatment effects are estimated in a single model.] CF model is written as follows:

```{=tex}
\begin{align*}
y_i = \sum_{i=2}^5 \theta_k(\alpha_i, \beta_i)\cdot T_k + g(\alpha_i, \beta_i)
\end{align*}
```

In this equation, $\theta_k(\alpha_i, \beta_i)$ represents the heterogenous treatment effect of $T_k$ as a function of site-specific characteristics $\alpha_i$ and $\beta_i$. For example, $\theta_2(\alpha_i, \beta_i)$ represents the impact of increasing N level from $N_1$ to $N_2$ at the observed soil chracteristic values. The final term, $g(\alpha_i, \beta_i)$, represents the direct impact of $\alpha_i$ and $\beta_i$ (not through a change in N rate).

Unlike the rest of the approaches, the estimated CF model cannot predict yield levels, rather it predicts the impact of treatments (changes in N rate). 

```{=tex}
\begin{align*}
y_i|_{N_k} - y_i|_{N_1} = \theta_k(\alpha_i, \beta_i)
\end{align*}
```

Then, the change in profit from increasing N rate from $N_1$ to $N_k$ for site $i$ is

```{=tex}
\begin{align*}
P_C\cdot \theta_k(\alpha_i, \beta_i) + P_N \cdot (N_k - N_1)
\end{align*}
```

The EONR for site $i$ is $N_k$ that produces the highest positive profit differntial unless all the profit differentials are negative, in which case, $N_1$ is the EONR.

### True model performance 

We use profit loss relative to the true site-specific EONR as the criteia for model performance as that is farmers' ultimate objective. The average per-acre profit from true site-specific EONR (denoted as $\pi_{true}$) is

\begin{equation}
\pi_{true}  = \frac{1}{N}\cdot \sum_{i=1}^{N} [P_c \cdot f(N^*_i, X_i) - P_N \cdot N^*_i]
(\#eq:label)
\end{equation}

This represents the maximum profit achievable average per-acre profit if you were to know the true site-specific EONR.

The average profit per acre associate with the site-specific N prescription by model $m$ (denoted as $\pi_m$), which is defined as

$$
\pi_m  = \frac{1}{N}\cdot \sum_{i=1}^{N} [P_c \cdot f(\widehat{N}^*_{m}(X_i), X_i) - P_N \cdot \widehat{N}^*_{m}(X_i)]
$$

Then the profit loss of model $m$ relative to the true maximum profit achievable (denoted as $\pi-loss_{m}$) is then defined as

$$
\Delta\pi_m  = \pi_{true} - \pi_m
$$

The lower the value of $\Delta\pi_m$, the better. We would like a model selection approach that is capable of selecting the true best model identified here. 

## Model Selection (Step 2-2)

We implement two model selection approaches: one based on yield prediction accuracy and the other based on local EONR prediction accuracy. For both approaches, spatial cross-validation is employed. The entire dataset is split into a train and test dataset in a spatially clustered manner, which is repeated to create multiple folds as depicted in @fig-fold-example. 

```{r}
#| label: fig-fold-example
#| fig-cap: "An example of the train-test split for each of the five folds."

knitr::include_graphics("FiguresTables/g_split_example.png")
```

Let $f$ and $F$ indicates a fold and the total number of folds, respectively.

### Model selection based on yield level prediction

For each of the candidate models, the following steps are implemented for each fold:

1. train the model using the train data of the fold
2. predict yield for each of the observations in the the test data based on the trained model ($\hat{y}_{i,f,m}$)
3. calculate RMSE of yield prediction as $RMSE-Yield_{f,m} = \sqrt{\sum_{i=1}^{N_t}(\hat{y}_{i,f,m} - y_{i,f,m})^2/N_t}$

Once this process is completed for all folds, the average RMSE for yield prediction is calculated for the model. This process is repeated for all the models, and the model with the lowest average RMSE is selected.

### Model selection based on local EONR 

In selecting a model for EONR prediction, it would be ideal if we could assess models based on their ability to estimate site-specific EONRs rather than yields because our ultimate interests lie in estimating EONRs, not yields. Of course, this is simply impossible because the true EONRs are never observable in the real world setting unlike yield. Our model selection approach attemps to overcome this challenge by validating models on "local uniform EONR" estimated by a statistical model in place of unobservable true EONR. In other words, we treat the estimated local EONR as the proxy for the true local EONR and select models that are capable of predicting the estimated local EONRs the best. Clearly, for our approach to perform well, it is vital that the estimation of local EONR is accurate enough. In this study, we will use the GAM model to find local EONR because it can estimate yield response function without making any functional form assumptions. We first lay out the entire process and then provide details of the steps.

For each fold and a given candidate model, the following steps are performed:

1. train the GAM model using the **test** data 
2. estimate uniform EONR for the **test** data ($\hat{N}^*_{f,gam}$)
3. train the candidate model using the **train** data 
4. estimate site-specific EONR for the **test** data based on the trained candidate model ($\hat{N}^*_{i, f,m}$). 
5. calcurate the average of the site-specific EONR from the step above ($\hat{N}^*_{f,m}$)

Once the above processes are completed for all folds, then the RMSE of estimating local EONR is calculated for the as follows:

```{=tex}
\begin{align}
RMSE-LE_{m} = \sqrt{\sum_{f=1}^F (\hat{N}^*_{f,m} - \hat{N}^*_{f,gam})^2 / F}
\end{align}
```

In step 1, the following GAM model is estimated:

```{=tex}
\begin{align*}
y_i = \sum_{j=1}^J \delta_j \phi_j(N_i)+ \varepsilon_i
\end{align*}
```

where $\phi_j(N_i)$ is $j$ th spline basis and $\delta_j$ is its coefficient. Collectively, $\sum_{j=1}^J \delta_j \phi_j(N_i)$ represents the the impact of N on corn yield. The model does not assume any functional form for the relationship between corn yield and N. Please note that neither $\alpha_i$ or $\beta_i$ are included as independent variables. It makes no attempt to identify interactive impact of N with $\alpha_i$ or $\beta_i$. It is important to keep the model simple to make the estimation task light-weighted so that it can estimate yield response function reasonably well with relatively small sample size of the test data.

Once the GAM model is trained, unfiorm (not variable) EONR is obtained by numerically solving the profit mamization problem. We call the estimated EONR "local EONR" because it is local to the test data. While the GAM model does not consider $\alpha_i$ or $\beta_i$ explicitly, the estimated yield response function embeds their information. For example, if the test data of a fold is located in a part of the field where soil characteristics are such that yield responds strongly to N, then that is reflected in the GAM's estimation of yield response in that area, and so are the estimated Local EONR.

Once the GAM model is trained, a uniform (not variable) EONR is obtained by numerically solving the profit maximization problem. We refer to the estimated EONR as "local EONR" because it is specific to the location of the test data. While the GAM model does not explicitly account for $\alpha_i$ or $\beta_i$, the estimated yield response function inherently captures their effects. For instance, if the test data for a given fold corresponds to a region of the field where soil characteristics lead to a strong yield response to nitrogen, this influence is embedded in the GAM’s estimation of the yield response for that area and, consequently, in the estimated local EONR. If a candidate model that explicitly accounts for the interaction between nitrogen and soil characteristics produces a similar local EONR, it indicates the model’s ability to statistically identify these interactive effects.

Steps 3 and 4 are exactly the same as Step 2-1 except that the candidate models are trained on the train data of the fold and site-specific EONR are estiamted for the test data of the fold.


## Evaluation of model selection performance (Step 3)

Model selection performance is evaluated based on the performance of the model selected by the model selection approach.

Two criterion to evaluate model selection performance are used. First, they are evaluated based on the percentage of the times the selection approach picked the true best model in estimating EONR. The second and more practically informative criteria is based on profit deficit when the selected model was used instead of the true best model. 

For example, let $m^*_f$ denote the true best model for a given field $f$, then the highest profit that could be achieved would be $\pi_{m^*_f}$ (defined in equation ..).
Not knowing what the true best model, one needs to rely on a model selection procedure to pick a model. Suppose the procedure suggested model $m$, then the profit loss relative to $\pi_{m^*_f}$ is $\pi_{m^*_f} - \pi_{m}$. If the produce is able to suggest the true best model, then the profit loss will be zero. The lower the value of profit loss, the better a selection approach is. 

# Results and Discussions

## Performance of the model selection approaches

@fig-selection-performance presents the number of times models are selected by the two model selection approaches and also selected as the actual best perfoming model in terms of site-specific EONR prediction using RMSE. Hereafter, we mean performing the best in predicting site-specific EONR by "performs the best" unless otherwise noted for the sake of consiseness. Yield-based model selection approach selected BRF for all the 500 simulation rounds. However, BRF was actually the best in only about 70 rounds. Among the candidate models, the linear spatial error model was the best most often at about 380 rounds. Our model selection approach, on the other hand, selects SE as often as it is selected as the actual best. Our model selection approach tends to select BRF much less than it is chosen as the actual best. 

```{r}
#| label: fig-selection-performance
#| fig-cap: "Frequency of models selected by the two selection approaches and selected as the actual best (lowest RMSE of site-specific EONR prediction)"
knitr::include_graphics("FiguresTables/g_ranking.png")
```

```{r}
accuracy_table <- readRDS("FiguresTables/selection_accuracy_table.rds")

main_table <- accuracy_table[num_repeats == 10 & num_folds == 10, ]

num_se_by_leonr <- main_table[method == "S-learner (SE)", num_selected_leonr]

num_se_by_leonr_correct <- main_table[method == "S-learner (SE)", num_selected_leonr_correct]

num_se_true <- main_table[method == "S-learner (SE)", num_selected_true]

num_all_by_lenor_correct <- main_table[, sum(num_selected_leonr_correct)]

num_lm_by_lenor <- main_table[method == "S-learner (Linear)", num_selected_leonr]

num_lm_by_lenor_correct <- main_table[method == "S-learner (Linear)", num_selected_leonr_correct]

num_brf_by_yield_correct <- main_table[method == "S-learner (BRF)", num_selected_yield_correct]
```

@fig-leonr-comp

```{r}
#| label: fig-leonr-comp
#| fig-cap: "Comparison of average model-estimated LEONR and GAM-estimated LEONR"
 
knitr::include_graphics("FiguresTables/g_leonr_comp.png")
```

Table \@ref(tab:accuracy-table) provides a deeper insights into the performance of the model selection approaches. Numbers in parenthesis indicate the number of times the model is selected. For example, the LEONR-based approach selected the SE model `r num_se_by_leonr` times. Numbers to the left of parenthesis indicates the number of times the model is correctly selected, meaning that a selection approacha selected the model that indeed performed the best. For example, among the `r num_se_true` times the SE model performed the best, the LEONR-based approach selected the SE model correclty `r num_se_by_leonr_correct` times. The LEONR-based approach selected the liner model `r num_lm_by_lenor` times, but its choice was correct only `r num_lm_by_lenor_correct` times. In total, the LEONR-based approach correctly selected the best model `r num_all_by_lenor_correct` times. The yield-based approach selected the BRF model for all the simulation rounds, while its choice is correct only `r num_brf_by_yield_correct` times. Overall, the LEONR-based approach performs far better than the yield-based approach.

```{r tab.id = "accuracy-table", tab.cap = "table-name"}
readRDS("FiguresTables/main_selection_accuracy_table.rds")
```

Even when a selection approach selects a model that is not the best in predicting site-specific EONR, the selection approach is considered performing well as long as its site-specific EONR is similar to that of the true model because the selected model would achieve a similar level of profit as that from the best model in such a circumstance. @fig-profit-loss presents the distribution of the loss in profit relative to the actual best model. For example, if a selection approach correctly selects the best model, then the profit loss for that round would be zero. However, if a selection approach selects a sub-optimal model and its site-specific EONR recommendation make $10/acre less than the profit generated by the recommendation from the best model, then the profit loss for that round is 10. Since agricultural producers' ultimate interest lies in the profitability, this measure is more relevant than the frequency of correctly secting the best model. As can be seen in the figure, the LEONR-based selection would result in a much smaller profit loss (much higher profit) compared to the yield-based selection.

```{r}
#| label: fig-profit-loss
#| fig-cap: "Distribution of profit loss relative to the actual best model"
knitr::include_graphics("FiguresTables/g_pi_loss.png")
```

# Conclusion


\newpage

# References

::: {#refs}
:::

\newpage

# Appendix

## Accuracy of Local EONR estimation with GAM

Our selection approach replaces true local EONRs with local EONRs estimated by GAM. Therefore, it goes without saying that the accuracy of local EONR estimation by GAM is critical for our selection approach. @fig-cor-gam-leonr presents the scatter plots of true LEONR (y-axis) and estimated LEONR (x-axis). Even though the GAM approach has a slight tendency to over-estimate LEONR (about $10$ lb/acre), it produces estimates that are highly correlated with true EONR, which is crucial for our approach to work. Our selection approach used GAM because it is capable of capturing the functional form of yield response to nitrogen without any functional form assumptions unlike quadratic or quadratic-plateaur functional forms typically used in empirical studies. However, our model selection approach is of course not just limited to GAM, and it may be worthwhile to explore other statistical approaches as a way to estimate LEONR in future studies.

```{r}
#| label: fig-cor-gam-leonr
#| fig-cap: "GAM vs True EONR"

knitr::include_graphics("FiguresTables/g_gam_leonr.png")
```

## The impact of different fold repeat combination on local EONR selection and yield selection method

```{r}
#| label: fig-fold-repeat
#| fig-cap: "The impact of different fold-repeat combinations on the performance of the model selection approaches based on local EONR and yield"

knitr::include_graphics("FiguresTables/g_sensitivity_fold_repeat.png")

```

@fig-fold-repeat presents a comparison of two model selection criteria: local EONR and yield-based, across various combinations of folds and repeats. The x-axis represents the ranking of the ML models in estimating true site-specific EONRs, with rank 1 indicating the best-performing model in estimating site-specific EONRs compared to the true EONRs.

In the context of local EONR model selection, the y-axis depicts the frequency of selecting the right model. The local EONR criterion consistently demonstrated an increasing trend in accuracy as the number of folds and repeats increased. For example, with 5 folds and 1 repeat, the correct model was selected in approximately 57.2 percent of simulations. This success rate improved to 58.4 percent with 5 repeats, and further to 62.4 percent with 7 folds and 5 repeats. Notably, increasing the number of folds to 10 while maintaining 5 repeats resulted in a substantial improvement, achieving a success rate of 65.8 percent. The pattern continued across different combinations, such as 5 folds and 10 repeats (59.4 percent success) and 10 folds and 10 repeats (65.2 percent success). This consistent improvement in accuracy underscores the positive impact of increasing the number of folds and repeats on the local EONR model selection.

In contrast, the yield-based model selection exhibited a lower success rate in identifying the best-performing model for EONR estimation. Across all combinations of folds and repeats, the yield-based method consistently achieved a success rate of approximately 14.2-14.4 percent. This low success rate remained largely unaffected by variations in the number of folds and repeats. Consequently, it can be inferred that altering the fold and repeat parameters did not significantly influence the performance of the yield-based model selection in accurately identifying the optimal model for EONR estimation.

The findings from these two model selection criteria highlight a clear distinction in their responses to different combinations of folds and repeats. While the local EONR criterion exhibited a notable increase in accuracy as folds and repeats were increased, the yield-based model selection method consistently demonstrated limited effectiveness across all scenarios. 

