---
title: "Simulation_results"
author: "Mona Mousavi"
date: "2023-02-07"
output: html_document
---

# Objective 

+ To see if the cross validation method based on local EONR can select the right model (the best in predicting EONR)
  - local EONR (GAM) vs EONR estaimtes from ML-based methods
+ How do we check whether our method is working or not (comparing with true EONR)

# Preparation

```{r}
library(tidyverse)
list.files(here::here("GitControlled/Codes/functions/"), full.names = TRUE) %>%
  lapply(., source)
```

# Run simulation

## Data

```{r}
all_data_files <- list.files(here::here("Shared/Data/SimData"), full.names = TRUE)
```

## Set up simulations

```{r}
cov_list <- c(
  "N", "theta_b2_2", "theta_b1_2",
  "Nk_2_1", "Nk_2_2", "Nk_1_1", "Nk_1_2",
  "plateau_2_1", "plateau_2_2", "plateau_1_1", "plateau_1_2"
)

cov_list_cf <- c(
  "theta_b2_2", "theta_b1_2",
  "Nk_2_1", "Nk_2_2", "Nk_1_1", "Nk_1_2",
  "plateau_2_1", "plateau_2_2", "plateau_1_1", "plateau_1_2"
)

pCorn <- 6.25 / 25.4 # $/kg
pN <- 1 / 0.453592 # $/kg
```

## Run simulations
```{r}
num_repeats <- 10
num_folds <- 6

results_dir <- paste0("Shared/Results/sim_results_num_repeats_", num_repeats, "_num_folds", num_folds)
dir.create(results_dir)

sim_results <-
  pbmclapply(
    1:length(all_data_files),
    function(x) {
      sim_single_field(
        file_path = all_data_files[x],
        results_dir = results_dir,
        num_repeats,
        num_folds
      )
    },
    mc.cores = 5
  )

```

```{r}
num_repeats <- 5
num_folds <- 5

sim_results <-
  mclapply(
    1:200,
    function(x) sim_single_field(x, raw_data, num_repeats, num_folds),
    mc.cores = 6
  )

saveRDS(
  sim_results,
  here(paste0(
    "Shared/Results/sim_results_num_repeats_", num_repeats, "_num_folds", num_folds, ".rds"
  ))
)
```